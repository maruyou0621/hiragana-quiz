import React, { useState } from "react";
import { kanaList } from "../data/kanaList"; // ãƒ‡ãƒ¼ã‚¿ã‚’å¤–éƒ¨ãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰å–å¾—
import AdBannerIncorrect from "./AdBannerIncorrect"; // ä¸æ­£è§£æ™‚ã®åºƒå‘Š

// ãƒ­ãƒ¼ãƒå­—ã‚’ã²ã‚‰ãŒãªã«å¤‰æ›ã™ã‚‹é–¢æ•°
const romajiToHiragana = (romaji) => {
  const romajiToHiraganaMap = {
    "a": "ã‚", "i": "ã„", "u": "ã†", "e": "ãˆ", "o": "ãŠ",
    "ka": "ã‹", "ki": "ã", "ku": "ã", "ke": "ã‘", "ko": "ã“",
    "sa": "ã•", "shi": "ã—", "su": "ã™", "se": "ã›", "so": "ã",
    "ta": "ãŸ", "chi": "ã¡", "tsu": "ã¤", "te": "ã¦", "to": "ã¨",
    "na": "ãª", "ni": "ã«", "nu": "ã¬", "ne": "ã­", "no": "ã®",
    "ha": "ã¯", "hi": "ã²", "fu": "ãµ", "he": "ã¸", "ho": "ã»",
    "ma": "ã¾", "mi": "ã¿", "mu": "ã‚€", "me": "ã‚", "mo": "ã‚‚",
    "ya": "ã‚„", "yu": "ã‚†", "yo": "ã‚ˆ",
    "ra": "ã‚‰", "ri": "ã‚Š", "ru": "ã‚‹", "re": "ã‚Œ", "ro": "ã‚",
    "wa": "ã‚", "wo": "ã‚’", "n": "ã‚“"
  };

  return romaji.split(/(?=[A-Z])/).map((syllable) => romajiToHiraganaMap[syllable.toLowerCase()] || syllable).join('');
};

// éŸ³å£°ã‚’å†ç”Ÿã™ã‚‹é–¢æ•°
const speakText = (text) => {
  const msg = new SpeechSynthesisUtterance(text);
  msg.lang = "ja-JP";  // æ—¥æœ¬èªã®éŸ³å£°ã§ç™ºéŸ³
  window.speechSynthesis.speak(msg);  // ãƒ†ã‚­ã‚¹ãƒˆã‚’éŸ³å£°ã«å¤‰æ›
};

// ãƒ©ãƒ³ãƒ€ãƒ ãªå•é¡Œã‚’å–å¾—
const getRandomQuestion = () => {
  const correct = kanaList[Math.floor(Math.random() * kanaList.length)];
  let options = new Set([correct.romaji]);
  while (options.size < 4) {
    options.add(kanaList[Math.floor(Math.random() * kanaList.length)].romaji);
  }
  return { correct, options: Array.from(options).sort(() => Math.random() - 0.5) };
};

export default function HiraganaQuiz() {
  const [question, setQuestion] = useState(getRandomQuestion());
  const [feedback, setFeedback] = useState("");
  const [showAd, setShowAd] = useState(false);

  const handleAnswer = (answer) => {
    const hiraganaAnswer = romajiToHiragana(answer); // ãƒ­ãƒ¼ãƒå­—ã‚’ã²ã‚‰ãŒãªã«å¤‰æ›ã—ã¦éŸ³å£°ã§èª­ã¿ä¸Šã’
    speakText(hiraganaAnswer);  // ã‚¯ãƒªãƒƒã‚¯ã—ãŸé¸æŠè‚¢ã‚’éŸ³å£°ã§èª­ã¿ä¸Šã’

    if (answer === question.correct.romaji) {
      setFeedback("âœ… æ­£è§£ï¼");
      setShowAd(false);
      setTimeout(() => {
        setFeedback("");
        setQuestion(getRandomQuestion());
      }, 1000);
    } else {
      setFeedback("âŒ ä¸æ­£è§£â€¦");
      setShowAd(true);

      // ğŸ”¥ ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã§åºƒå‘Šã‚’é–‹ã
      window.open("https://px.a8.net/svt/ejp?a8mat=44Z2FF+E22GZ6+348+6C1VL", "åºƒå‘Šã‚µã‚¤ãƒˆ", "width=600,height=400");
    }
  };

  return (
    <div className="quiz-container">
      <h1 className="quiz-title">ã²ã‚‰ãŒãªãƒ»ã‚«ã‚¿ã‚«ãƒŠã‚¯ã‚¤ã‚º</h1>
      <p className="quiz-question">{question.correct.kana}</p>
      <div className="quiz-options">
        {question.options.map((option) => (
          <button key={option} className="quiz-button" onClick={() => handleAnswer(option)}>
            {option}
          </button>
        ))}
      </div>
      <p className="quiz-feedback">{feedback}</p>

      {/* ğŸ”¥ ä¸æ­£è§£æ™‚ã«A8.netåºƒå‘Šã‚’è¡¨ç¤º */}
      {showAd && <AdBannerIncorrect />}
    </div>
  );
}
